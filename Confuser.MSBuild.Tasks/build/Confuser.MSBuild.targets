<?xml version="1.0" encoding="utf-8" ?>
<Project>
  <PropertyGroup>
    <ConfuserKeyFile Condition="'$(ConfuserKeyFile)' == ''">$(AssemblyOriginatorKeyFile)</ConfuserKeyFile>
    <ConfuserIntermediateOutputPath Condition="'$(ConfuserIntermediateOutputPath)' == ''">$(IntermediateOutputPath)confused\</ConfuserIntermediateOutputPath>
    <ConfuserReplaceOutput Condition="'$(ConfuserReplaceOutput)' == ''">false</ConfuserReplaceOutput>
    <ConfuserOutDir Condition="'$(ConfuserOutDir)' == ''">$(OutDir)confused\</ConfuserOutDir>
  </PropertyGroup>

  <PropertyGroup Condition="'$(ConfuserProject)' == ''">
    <ConfuserProject Condition="Exists('$(MSBuildProjectDirectory)\$(MSBuildProjectName).crproj')">$(MSBuildProjectDirectory)\$(MSBuildProjectName).crproj</ConfuserProject>
  </PropertyGroup>

  <Target AfterTargets="ResolveReferences"
          Condition="$(DesignTimeBuild) != true And $(Obfuscate) == true"
          Name="CreateConfuserProject"
          DependsOnTargets="$(CreateConfuserProjectDependsOnTargets)"
          Inputs="@(IntermediateAssembly->'%(FullPath)');$(ConfuserProject)"
          Outputs="@(IntermediateAssembly->'$(IntermediateOutputPath)%(Filename).crproj')">
    <Confuser.MSBuild.Tasks.CreateProjectTask
      SourceProject="$(ConfuserProject)"
      References="@(ReferencePath)"
      AssemblyPath="@(IntermediateAssembly)"
      KeyFilePath="$(ConfuserKeyFile)"
      ResultProject="@(IntermediateAssembly->'$(IntermediateOutputPath)%(Filename).crproj')"/>
  </Target>

  <PropertyGroup>
    <ConfuseAssemblyDependsOn>
      $(ConfuseAssemblyDependsOn);
      CreateConfuserProject
    </ConfuseAssemblyDependsOn>
  </PropertyGroup>

  <Target AfterTargets="Compile"
          Condition="Exists('@(IntermediateAssembly)') And $(DesignTimeBuild) != true And $(Obfuscate) == true"
          Name="ConfuseAssembly"
          DependsOnTargets="$(ConfuseAssemblyDependsOn)"
          Inputs="@(IntermediateAssembly->'%(FullPath)');@(IntermediateAssembly->'$(IntermediateOutputPath)%(Filename).crproj')"
          Outputs="@(IntermediateAssembly->'$(ConfuserIntermediateOutputPath)%(Filename)%(Extension)')">
    <Confuser.MSBuild.Tasks.ConfuseTask
      Project="@(IntermediateAssembly->'$(IntermediateOutputPath)%(Filename).crproj')"
      OutputAssembly="@(IntermediateAssembly->'$(ConfuserIntermediateOutputPath)%(Filename)%(Extension)')" />
  </Target>

  <Target Name="_ReplaceOutputWithConfusedAssemblies"
          AfterTargets="ConfuseAssembly"
          Condition="$(DesignTimeBuild) != true And $(Obfuscate) == true and '$(ConfuserReplaceOutput)' == 'true'"
          DependsOnTargets="ConfuseAssembly">
    <CreateItem Include="@(IntermediateAssembly->'$(ConfuserIntermediateOutputPath)%(Filename)%(Extension)')">
      <Output TaskParameter="Include" ItemName="IntermediateConfusedAssembly" />
    </CreateItem>
    <ItemGroup>
      <IntermediateAssembly Remove="@(IntermediateAssembly)" />
    </ItemGroup>
    <CreateItem Include="@(IntermediateConfusedAssembly)">
      <Output TaskParameter="Include" ItemName="IntermediateAssembly" />
    </CreateItem>
  </Target>
  
  <Target Name="_ReplaceDebugOutputWithConfusedAssemblies"
          AfterTargets="ConfuseAssembly"
          Condition="$(DesignTimeBuild) != true And $(Obfuscate) == true and '$(ConfuserReplaceOutput)' == 'true' and '@(_DebugSymbolsIntermediatePath') != ''"
          DependsOnTargets="ConfuseAssembly">
    <CreateItem Include="@(IntermediateAssembly->'$(ConfuserIntermediateOutputPath)%(Filename).pdb')">
      <Output TaskParameter="Include" ItemName="_ConfusedDebugSymbolsIntermediatePath" />
    </CreateItem>
    <ItemGroup>
      <_DebugSymbolsIntermediatePath Remove="@(_DebugSymbolsIntermediatePath)" />
    </ItemGroup>
    <CreateItem Include="@(_ConfusedDebugSymbolsIntermediatePath)">
      <Output TaskParameter="Include" ItemName="_DebugSymbolsIntermediatePath" />
    </CreateItem>
  </Target>

  <Target Name="CopyConfusedFilesToOutputDirectory"
          Condition="$(DesignTimeBuild) != true And $(Obfuscate) == true and '$(ConfuserReplaceOutput)' != 'true'"
          AfterTargets="CopyFilesToOutputDirectory">
    <PropertyGroup>
      <!-- By default we're not using Hard Links to copy to the output directory, and never when building in VS -->
      <CreateHardLinksForCopyFilesToOutputDirectoryIfPossible Condition="'$(BuildingInsideVisualStudio)' == 'true' or '$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)' == ''">false</CreateHardLinksForCopyFilesToOutputDirectoryIfPossible>
      <CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible Condition="'$(BuildingInsideVisualStudio)' == 'true' or '$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)' == ''">false</CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible>
    </PropertyGroup>

    <PropertyGroup>
      <CopyBuildOutputToOutputDirectory Condition="'$(CopyBuildOutputToOutputDirectory)'==''">true</CopyBuildOutputToOutputDirectory>
      <CopyOutputSymbolsToOutputDirectory Condition="'$(CopyOutputSymbolsToOutputDirectory)'==''">true</CopyOutputSymbolsToOutputDirectory>
    </PropertyGroup>

    <!-- Copy the confused build product (.dll or .exe). -->
    <Copy
      SourceFiles="@(IntermediateAssembly->'$(ConfuserIntermediateOutputPath)%(Filename)%(Extension)')"
      DestinationFolder="$(ConfuserOutDir)"
      SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
      OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
      Retries="$(CopyRetryCount)"
      RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
      UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
      UseSymboliclinksIfPossible="$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)"
      Condition="'$(CopyBuildOutputToOutputDirectory)' == 'true' and '$(SkipCopyBuildProduct)' != 'true'">
      
      <Output TaskParameter="DestinationFiles" ItemName="MainAssembly"/>
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>
      
    </Copy>
    
    <!-- Copy the debug information file (.pdb), if any -->
    <Copy
        SourceFiles="@(IntermediateAssembly->'$(ConfuserIntermediateOutputPath)%(Filename).pdb')"
        DestinationFolder="$(ConfuserOutDir)"
        SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
        OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
        Retries="$(CopyRetryCount)"
        RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
        UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
        UseSymboliclinksIfPossible="$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)"
        Condition="'$(_DebugSymbolsProduced)'=='true' and '$(SkipCopyingSymbolsToOutputDirectory)' != 'true' and '$(CopyOutputSymbolsToOutputDirectory)'=='true'">
        
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>
      
    </Copy>
  </Target>
</Project>
